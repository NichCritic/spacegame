<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>hello pixi!</title>
        <script src="https://pixijs.download/v4.6.0/pixi.min.js"></script>
        <script src="static/js/keyboard.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="static/js/utils.js"></script>
        <script src="static/js/io.js"></script>
        <script src="static/js/gamestate.js"></script>
        <script src="static/js/circularArrayBuffer.js"></script>
        <script src="static/js/camera.js"></script>
        <script src="static/js/inputs.js"></script>
        <script src="static/js/gameloop.js"></script>
        <script src="static/js/menu.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {


        var bg, stars, textures, gamestate;
        var frame = 0;

        var keys = {};
        
        var sprites = [];

        var serverState = {};

        

        var is_menu = false;

        //Create the renderer
        var renderer = PIXI.autoDetectRenderer(1200, 600);

        //Add the canvas to the HTML document
        document.body.appendChild(renderer.view);

        PIXI.loader.add('static/assets/parallax-space-background2.png')
                   .add('static/assets/parallax-space-stars2.png')
                   .add('static/assets/ship.png')
                   .add('static/assets/ship_idle.png')
                   .add('static/assets/laser-bolt.png')
                   .add('static/assets/spacestation1.png')
                   .add('static/assets/bolfenn.png')
                   .load(setup)

       


        function getTexturesFromSpritesheet(mySpriteSheetImage, count, rows, imgW, imgH){
            var textures = [];
            var countPerRow = Math.floor(count/rows);

            for(var i = 0; i < count; i++) {
                let x = (i % countPerRow) * imgW;
                let y = Math.floor(i/countPerRow) * imgH;
                let frame = new PIXI.Rectangle(x, y, imgW, imgH);
                let texture = new PIXI.Texture(mySpriteSheetImage, frame);
                textures.push(texture);
            }
            return textures
        }
        

        function initSprite(id, type){
            
        }

        function setup() {
            bg = new PIXI.Sprite(
                PIXI.loader.resources["static/assets/parallax-space-background2.png"].texture
            );
            stars = new PIXI.extras.TilingSprite(
                PIXI.loader.resources["static/assets/parallax-space-stars2.png"].texture
            , 1200, 600);
            

            var ship_accel  = PIXI.BaseTexture.fromImage("static/assets/ship.png");
            var ship_idle = PIXI.BaseTexture.fromImage("static/assets/ship_idle.png");

            var bolt = PIXI.BaseTexture.fromImage("static/assets/laser-bolt.png")
            // var spacestation1 = PIXI.BaseTexture.fromImage("static/assets/spacestation1.png")

            textures = {}
            textures.ship = {}
            textures.ship.accelerating = getTexturesFromSpritesheet(ship_accel, 10, 2, 16, 24);
            textures.ship.idle = getTexturesFromSpritesheet(ship_idle, 10, 2, 16, 24);

            textures.bolt = {};
            textures.bolt.idle = getTexturesFromSpritesheet(bolt, 2, 1, 7, 13)
            textures.bolt.accelerating = getTexturesFromSpritesheet(bolt, 2, 1, 7, 13)

            
            textures.spacestation1 = {};
            textures.spacestation1.idle = [PIXI.loader.resources["static/assets/spacestation1.png"].texture];
            textures.spacestation1.accelerating = [PIXI.loader.resources["static/assets/spacestation1.png"].texture];

            textures.bolfenn = {};
            textures.bolfenn.idle = [PIXI.loader.resources["static/assets/bolfenn.png"].texture];
            textures.bolfenn.accelerating = [PIXI.loader.resources["static/assets/bolfenn.png"].texture];

            textures.stars = stars;
            textures.bg = bg;

            stage.addChild(bg)
            stage.addChild(stars)
            
            keys.up = keyboard(38);
            keys.left = keyboard(37);
            keys.right = keyboard(39);
            keys.d = keyboard(68);
            keys.f = keyboard(70);
            

            setup_menu(keys);

            requestAnimationFrame(update)
        }

        

        

        

        

        var sim_time= 0;
        var inputs = new InputList();
        var last_time = Date.now();
        var framecounter = 0
        

        
        

        

        var mode = game_state;

        function update() {

            requestAnimationFrame(update)
            // Sample clock to find start time
            var time = Date.now();
            sim_time = time - last_time;

            var unprocessed_input = mode.get_input(inputs, keys, time, sim_time);
            
            

            state = mode.get_state();

            state = mode.update(state, sim_time, unprocessed_input);

            // Render Scene
            mode.render(renderer, textures, sprites, state, mode.stage);
            // Sample clock to find end time
            last_time = time;
            
            mode.update_server();
            
        }
        
       

    };

    </script>

    </body>
</html>